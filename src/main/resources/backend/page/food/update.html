<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css" />
    <link rel="stylesheet" href="../../styles/common.css" />
    <link rel="stylesheet" href="../../styles/page.css" />
    <style>
        /* ... 你的样式 ... */
    </style>
</head>
<body>
<div class="addBrand-container" id="food-add-app">
    <div class="container">
        <el-form
                ref="ruleForm"
                :model="ruleForm"
                :rules="rules"
                :inline="true"
                label-width="180px"
                class="demo-ruleForm"
        >
            <!-- ... 你的表单项 ... -->
            <el-form-item>
                <el-button @click="goBack()">取消</el-button>
                <el-button type="primary" @click="submitForm('ruleForm')">保存</el-button>
            </el-form-item>
        </el-form>
    </div>
</div>

    <!-- 引入 Vue.js 和其他依赖 -->
    <script src="../../plugins/vue/vue.js"></script>
    <script src="../../plugins/element-ui/index.js"></script>
    <script src="../../plugins/axios/axios.min.js"></script>
    <script src="../../js/request.js"></script>
    <script src="../../js/validate.js"></script>
    <script src="../../js/index.js"></script>
    <script src="../../api/food.js"></script>

    <script>
        new Vue({
            el: '#food-add-app',
            data() {
                return {
                    productId: '',
                    restKey: 0,
                    textarea: '',
                    value: '',
                    actionType: '',
                    vueRest: '1',
                    index: 0,
                    inputStyle: { 'flex': 1 },
                    ruleForm: {
                        name: '',
                        tenure: '',
                        annualInterestRate: '',
                        minDepositAmount: '',
                        singleLimitAmount: '',
                        dailyLimitAmount: '',
                        riskLevel: '',
                        startDate: '',
                        maturityDate: '',
                        interestPayment: '',
                        productStatus: '',
                    },
                    mak: false
                };
            },
            computed: {
                rules() {
                    return {
                        name: [{ required: true, message: '请输入产品名称', trigger: 'blur' }],
                        tenure: [{required: true, message: '请输入产品期限', trigger: 'blur'}],
                        annualInterestRate: [{required: true, message: '请输入年化利率', trigger: 'blur'}],
                        minDepositAmount: [{required: true, message: '请输入起存金额', trigger: 'blur'}],
                        singleLimitAmount: [{required: true, message: '请输入单人限额', trigger: 'blur'}],
                        dailyLimitAmount: [{required: true, message: '请输入单日限额', trigger: 'blur'}],
                        riskLevel: [{required: true, message: '请选择风险等级', trigger: 'blur'}],
                        startDate: [{required: true, message: '请选择起息日', trigger: 'blur'}],
                        maturityDate: [{required: true, message: '请选择到期日', trigger: 'blur'}],
                        interestPayment: [{required: true, message: '请选择结息方式', trigger: 'blur'}],
                        productStatus: [{required: true, message: '请选择产品状态', trigger: 'blur'}],
                    };
                }
            },
            created() {
                this.productId = requestUrlParam('productId');
                console.log('this.productId:', this.productId);
                this.actionType = 'edit';
                if (this.productId) {
                    this.init();
                }
            },
            methods: {
                async init() {
                    queryproductById(this.productId).then(res => {
                        console.log(res);
                        if (String(res.code) === '1') {
                            this.ruleForm = { ...res.data };
                        } else {
                            this.$message.error(res.msg || '操作失败');
                        }
                    });
                },
                submitForm(formName, st) {
                    this.$refs[formName].validate((valid) => {
                        if (valid) {
                            let params = { ...this.ruleForm };
                            if (!st) {
                                this.goBack();
                            } else {
                                this.ruleForm = {
                                    name: '',
                                    tenure: '',
                                    annualInterestRate: '',
                                    minDepositAmount: '',
                                    singleLimitAmount: '',
                                    dailyLimitAmount: '',
                                    riskLevel: '',
                                    startDate: '',
                                    maturityDate: '',
                                    interestPayment: '',
                                    productStatus: '',
                                };
                            }
                            delete params.updateTime;
                            editproduct(params).then((res) => {
                                if (res.code === 1) {
                                    this.$message.success('产品修改成功！');
                                    if (st) {
                                        this.goBack();
                                    }
                                } else {
                                    this.$message.error(res.msg || '操作失败');
                                }
                            }).catch((err) => {
                                this.$message.error('请求出错了：' + err);
                            });
                        } else {
                            this.$message.error('表单验证失败，请检查输入！');
                        }
                    });
                },

                handleAvatarSuccess (response, file, fileList) {
                    // 拼接down接口预览
                    if(response.code === 0 && response.msg === '未登录'){
                        window.top.location.href = '/backend/page/login/login.html'
                    }else{
                        this.imageUrl = `/common/download?name=${response.data}`
                        this.ruleForm.image = response.data
                    }
                },

                onChange (file) {
                    if(file){
                        const suffix = file.name.split('.')[1]
                        const size = file.size / 1024 / 1024 < 2
                        if(['png','jpeg','jpg'].indexOf(suffix) < 0){
                            this.$message.error('上传图片只支持 png、jpeg、jpg 格式！')
                            this.$refs.upload.clearFiles()
                            return false
                        }
                        if(!size){
                            this.$message.error('上传文件大小不能超过 2MB!')
                            return false
                        }
                        return file
                    }
                },

                goBack() {
                    window.parent.menuHandle({
                        id: '4',
                        url: '/backend/page/food/list.html',
                        name: '产品管理'
                    }, false);
                }
            }
        });
    </script>
</body>
</html>
